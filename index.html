<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Health Tracker — Data Entry</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0f14">
  <link rel="apple-touch-icon" href="icon/icon-192.png">

  <style>
    :root { color-scheme: dark; }
    /* --- Base (mobile first) --- */
    body{ margin:0; font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; background:#0b0f14; color:#e6edf3; }
    header{ position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(4px);
      background:rgba(11,15,20,.72); padding:14px 16px; border-bottom:1px solid #1f2a34; display:flex; align-items:center; justify-content:space-between;}
    a{ color:#7cc7ff; text-decoration:none; }
    .container{ max-width:880px; margin:16px auto 48px; padding:0 12px; }
    .card{ background:#0f141b; border:1px solid #1f2a34; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
    h1{ margin:4px 0 6px; font-size:22px; line-height:1.2;}
    p.muted{ color:#9fb3c8; margin:0 0 12px; font-size:14px }

    /* Form: single column on phones */
    form{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:4px;}
    label{ font-size:14px; color:#c8d4e0; display:block }
    input{ margin-top:6px; width:100%; padding:14px 12px; border-radius:12px; border:1px solid #243342; background:#0b1117; color:#e6edf3; font-size:16px; }
    input[type="number"]{ -moz-appearance:textfield; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    .actions{ display:flex; gap:10px; align-items:center; }
    button{ padding:14px 18px; border-radius:12px; border:1px solid #2b3b4c; background:#1a2533; color:#e6edf3; font-size:16px; touch-action:manipulation; }
    button:active{ transform:translateY(1px); }
    .tip{ color:#8aa6bf; font-size:12px;}

    /* Calendar */
    .calendar{ margin-top:18px; }
    h2{ font-size:20px; margin:10px 0 8px; }
    table{ width:100%; border-collapse:separate; border-spacing:6px; table-layout:fixed; }
    th{ color:#9fb3c8; font-weight:600; font-size:12px; }
    td{ text-align:center; padding:0; border:1px solid #1f2a34; border-radius:10px; cursor:pointer; user-select:none; aspect-ratio: 1 / 1; font-weight:600; }
    td span{ display:flex; align-items:center; justify-content:center; height:100%; width:100%; }
    .done{ background:#1e4028; color:#bdf7c9; }
    .missed{ background:#3a2323; color:#ffc1c1; }
    td:empty{ cursor:default; border:none; background:transparent; }

    /* --- Tablets / desktop --- */
    @media (min-width: 600px){
      .container{ margin-top:24px; padding:0 16px; }
      .card{ padding:24px; }
      h1{ font-size:24px }
      form{ grid-template-columns:repeat(2, minmax(0,1fr)); gap:16px; }
      .actions{ grid-column:1/-1; }
      h2{ font-size:22px }
      th{ font-size:13px }
    }
  </style>
</head>
<body>
  <header>
    <div><strong>Health Tracker</strong> — Daily FBS & BP</div>
    <nav><a href="dashboard.html">Dashboard →</a></nav>
  </header>

  <main class="container">
    <div class="card">
      <h1>Enter Today’s Readings</h1>
      <p class="muted">Data is saved to a secure Google Sheet so you can see it anywhere.</p>

      <form id="entry-form">
        <div>
          <label>Date
            <input type="date" id="date" required />
          </label>
        </div>
        <div>
          <label>Fasting Blood Sugar (mg/dL)
            <input type="number" id="fbs" inputmode="numeric" min="40" max="400" step="1" required />
          </label>
        </div>
        <div>
          <label>Systolic BP (mmHg)
            <input type="number" id="sbp" inputmode="numeric" min="60" max="250" step="1" required />
          </label>
        </div>
        <div>
          <label>Diastolic BP (mmHg)
            <input type="number" id="dbp" inputmode="numeric" min="40" max="150" step="1" required />
          </label>
        </div>

        <div class="actions">
          <button type="submit">Save entry</button>
          <span class="tip" id="status"></span>
        </div>
      </form>

      <!-- Calendar -->
      <div class="calendar">
        <h2>Submission Calendar — <span id="monthName"></span></h2>
        <table id="calendarTable"></table>
      </div>
    </div>
  </main>

  <script>
    // 1) PUT YOUR APPS SCRIPT WEB APP URL HERE (must end with /exec)
    const API_URL = 'https://script.google.com/macros/s/AKfycbz3WmbuwCicVLQ37UGJ63F6eAJRFUtHNPkFsEnExo6vLw5dwaCY5i6uC3tKXjFDNvo6/exec';

    // Pre-fill today
    document.getElementById('date').valueAsDate = new Date();

    async function fetchRows(){
      try{
        const res = await fetch(`${API_URL}?mode=fetch`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || 'API not ok');
        return data.rows || [];
      }catch(err){
        document.getElementById('status').textContent = `Fetch failed: ${err.message}`;
        return [];
      }
    }

    // *** FORM-ENCODED POST (no CORS preflight) ***
    async function saveRow(row){
      try{
        const form = new URLSearchParams(row);
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: form.toString()
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'API not ok');
        return true;
      }catch(err){
        document.getElementById('status').textContent = `Save failed: ${err.message}`;
        return false;
      }
    }

    async function buildCalendar(){
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      document.getElementById('monthName').textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const rows = await fetchRows();
      const datesWithEntries = new Set(rows.map(r=>r.date));

      let html = "<tr>";
      ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=> html += `<th>${d}</th>`);
      html += "</tr><tr>";
      for(let i=0;i<firstDay;i++) html += "<td></td>";

      for(let day=1; day<=daysInMonth; day++){
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const cls = datesWithEntries.has(dateStr) ? "done" : "missed";
        html += `<td class="${cls}" data-date="${dateStr}"><span>${day}</span></td>`;
        if((firstDay + day) % 7 === 0) html += "</tr><tr>";
      }
      html += "</tr>";
      const table = document.getElementById('calendarTable');
      table.innerHTML = html;

      table.querySelectorAll('td[data-date]').forEach(td=>{
        td.addEventListener('click', ()=> location.href = `dashboard.html?date=${td.dataset.date}`);
      });
    }

    document.getElementById('entry-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const date = document.getElementById('date').value;
      const fbs  = Number(document.getElementById('fbs').value);
      const sbp  = Number(document.getElementById('sbp').value);
      const dbp  = Number(document.getElementById('dbp').value);
      if(!date || isNaN(fbs) || isNaN(sbp) || isNaN(dbp)){
        document.getElementById('status').textContent = 'Please fill all fields correctly.';
        return;
      }
      document.getElementById('status').textContent = 'Saving…';
      const ok = await saveRow({ date, fbs, sbp, dbp, device: navigator.userAgent.slice(0,50) });
      document.getElementById('status').textContent = ok ? 'Saved ✔' : document.getElementById('status').textContent;
      if(ok) buildCalendar();
      setTimeout(()=>document.getElementById('status').textContent='', 2500);
    });

    buildCalendar();
  </script>

  <!-- PWA: register service worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    }
  </script>
</body>
</html>
